<?php /* 程序侠版权所有 技术论坛支持: bbs.chengxuxia.com QQ: 573907419 正版授权防止出现漏洞后门
-- enphp : https://git.oschina.net/mz/mzphp2
 */   namespace app\admin\model;error_reporting(E_ALL^E_NOTICE);define('', '');־՜Ɓ ٻܮ􂘠ۭшӎ򱼄Èߢʀ͘ί̧ꃉۘ錃ԎԦޢъ;$_SERVER[] = explode('|<|!|=', '|<|!|=|<|!|=|?|$|8|<|!|=AdminGroup|?|$|8id|?|$|8gid|?|$|8username|?|$|8status|?|$|8用户不存在或被禁用！|?|$|8密码错误！|?|$|8登录日志记录失败|?|$|8登录信息更新失败，请重新登录！|?|$|8超级管理员|?|$|8title|?|$|8uid|?|$|8group|?|$|8last_login_time|?|$|8last_login_ip|?|$|8user_auth|?|$|8user_auth_sign|?|$|8signin_token|?|$|8?uid|?|$|8?signin_token|?|$|8id|?|$|8password');֟;error_reporting(E_ALL^E_NOTICE);define($_SERVER{}[0],$_SERVER{}{0x001});ȳҌڢ򐺍ܹƗ՞׬ǋ渌ό߂糜ێú;$_SERVER[]=explode($_SERVER{}[0x0002],$_SERVER{}{0x00003});֙ҝ톹Ⰴ޵󠑸ڳ땐³흥ͪì߿ۅġÏᙔм;use think\Model;use think\Db;use app\admin\model\LoginLog as LoginLogModle;class AdminUser extends Model{protected $autoWriteTimestamp=true;public function group(){$=&$_SERVER{};return $this->hasOne($[0],${0x001},$[0x0002]);׫̅нˤϝ濤ؘ㇜릦ՎݕطƼ;}public function login($Ĉ='',$ڈ='',$۟=false){$=&$_SERVER{};ɿ;$Ĉ=trim($Ĉ);$ڈ=trim($ڈ);$[${0x00003}]=$Ĉ;ݞٓ࿾ưղГȴ֛;$[$[0x000004]]=0x001;户ސ;ǫĆޟْԍߠ;ܔؔۄۈӆ畚ݼҽց;$=$this::get($);ҧ;➾¥Ŧ;if(!$){$this->error=${0x05};}else{if(MD5($ڈ)!=$->password){$this->error=$[0x006];}else{$=$->id;if(!LoginLogModle::loginLog($)){$this->error=${0x0007};return !0x001;}$->last_login_time=request()->time();$->last_login_ip=request()->ip();$->login_count += 0x001;ɃƼ𭼜ޝ篯;if($->save()){return $this->autoLogin($this::get($),$۟);}else{$this->error=$[0x00008];return !0x001;}}}return !0x001;Ǽ⼢ƴώǣܿѾ;Ӕ񼻸ӱ͉؊Ɔ;}public function autoLogin($,$Ӟ=false){$=&$_SERVER{};$׍=$->id==0x001 ?${0x000009}:Db::name($[0])->where(${0x001},$->id)->value($[0x0a]);ίԶǌ;$=[${0x00b}=>$->id,$[0x000c]=>$׍,$[0x0002]=>$->gid,${0x00003}=>$->username,${0x0000d}=>$->last_login_time,$[0x00000e]=>$->last_login_ip,];session(${0x0f},$);ްยƛ󅏤;ή;Ύ;session($[0x0010],$this->dataAuthSign($));if($Ӟ){$͓=$->username.$->id.$->last_login_time.$->last_login_ip;cookie(${0x00b},$->id,0x0000018*0x0e10*0x0007);cookie(${0x00011},$this->dataAuthSign($͓),0x0000018*0x0e10*0x0007);}return $->id;}public function dataAuthSign($=[]){if(!is_array($)){$=(array)$;}ksort($);$=http_build_query($);$=sha1($);ǴĻևȦȹ̒ѺޖţګƔ;return $;}public function isLogin(){$ӭ=&$_SERVER{};귥ɋߩٔأ;$=session($ӭ{0x0f});;if(empty($)){if(cookie($ӭ[0x000012])&& cookie($ӭ{0x0000013})){$=$this::get(cookie($ӭ{0x00b}));if($){$=$this->dataAuthSign($->username.$->id.$->last_login_time.$->last_login_ip);if(cookie($ӭ{0x00011})==$){$this->autoLogin($,!0);return $->id;}}};߉ΙӤ؏Ͼ;Ȍơ׫ۤבТ;return 0;̳ݫƵ؈ժ;}else{return session($ӭ[0x0010])==$this->dataAuthSign($)?$[$ӭ{0x00b}]:0;嶬ݟ;;}}public function updatePassword($,$){$ݘ=&$_SERVER{};אٜǓߥ;return $this->where($ݘ[0x014],$)->update([$ݘ{0x0015}=>MD5($)]);幣ۼ;}}